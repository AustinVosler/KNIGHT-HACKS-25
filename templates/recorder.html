{% extends "base.html" %}

{% block body_class %}recorder-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/index.css" />
<link rel="stylesheet" href="/static/css/recorder.css" />
{% endblock %}

{% block content %}
  <h1 class="brand">Record Your Video</h1>
  <div class="recorder-frame">
    <video id="preview" width="640" height="480" autoplay></video>
  </div>
  <div class="recorder-actions">
    <button class="cta recorder-btn" id="recordBtn">Start Recording</button>
  </div>
  <form id="uploadForm">
    <input type="text" id="filename" name="filename" placeholder="Enter a name" required />
    <button type="submit" class="cta uploadForm">Upload Video</button>
  </form>
{% endblock %}

{% block scripts %}
<script>
  const preview = document.getElementById("preview");
  const recordBtn = document.getElementById("recordBtn");
  const uploadForm = document.getElementById("uploadForm");

  uploadForm.classList.add("hidden");

  let mediaRecorder;
  let recordedChunks = [];
  let isRecording = false;
  let id = null;

  let videoFile;

  // Get access to the webcam
  navigator.mediaDevices
    .getUserMedia({ video: true, audio: true })
    .then((stream) => {
      preview.srcObject = stream;

      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedChunks = [];

        // Upload video to server
        videoFile = new File([blob], "blob.webm", { type: 'video/webm' });
        const formData = new FormData();
        formData.append('file', videoFile);

        fetch('/api/videos', {
          method: 'POST',
          body: formData
        }).then(response => response.json())
        .then(data => {
          console.log("Video uploaded with ID: ", data.id);
          id = data.id;
        }).catch(err => {
          console.error(err);
        });
      };
    })
    .catch((err) => {
      console.error("Error accessing webcam: ", err);
    });

  recordBtn.onclick = () => {
    if (!isRecording) {
      mediaRecorder.start();
      isRecording = true;
      recordBtn.textContent = "Stop Recording";
      recordBtn.classList.add("recording");
    } else {
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.textContent = "Start Recording";
      recordBtn.classList.remove("recording");
      showPreview();
    }
  };

  uploadForm.onsubmit = (e) => {
    e.preventDefault();
    const filenameInput = document.getElementById("filename");
    let filename = filenameInput.value.trim();
    if (!filename) {
      alert("Please enter a valid filename.");
      return;
    }
    // Ensure filename ends with .webm
    if (!filename.endsWith(".webm")) {
      filename += ".webm";
    }
    const formData = new FormData();
    formData.append('fileName', filename);

    fetch(`/api/videos/${id}`, {
      method: 'PUT',
      body: formData
    }).then(response => {
      // alert('Video uploaded successfully!');
    }).catch(err => {
      console.error(err);
    });
  };

  async function showPreview(){
    recordBtn.classList.add("hidden")
    preview.srcObject.getTracks().forEach(track => track.stop());
    preview.srcObject = null;
    while(videoFile === undefined){
      await new Promise(r => setTimeout(r, 100));
    }
    const url = URL.createObjectURL(videoFile);
    preview.src = url;
    preview.controls = true;
    preview.autoplay = false;

    uploadForm.classList.remove("hidden");
  }
// ...existing code...
</script>
{% endblock %}