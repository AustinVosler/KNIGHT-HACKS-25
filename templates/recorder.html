{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/index.css" />
{% endblock %}

{% block content %}
  <h1 class="brand">Record Your Video</h1>
  <video id="preview" width="640" height="480" autoplay></video>
  <br />
  <button class="cta" id="startBtn">Start Recording</button>
  <button class="cta" id="stopBtn" disabled>Stop Recording</button>
{% endblock %}

{% block scripts %}
<script>
  const preview = document.getElementById("preview");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  let mediaRecorder;
  let recordedChunks = [];

  // Get access to the webcam
  navigator.mediaDevices
    .getUserMedia({ video: true, audio: true })
    .then((stream) => {
      preview.srcObject = stream;

      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedChunks = [];

        let fileName = prompt("Enter a name for your masterpiece:", "my_video");
        if (!fileName) {
          fileName = "untitled_video";
        }

        // Make sure filename ends with .webm
        if (!fileName.endsWith(".webm")) {
          fileName += ".webm";
        }

        // Upload video to server
        const videoFile = new File([blob], fileName, { type: 'video/webm' });
        const formData = new FormData();
        formData.append('file', videoFile);

        fetch('/api/videos', {
          method: 'POST',
          body: formData
        }).then(response => {
          alert('Video uploaded successfully!');
        }).catch(err => {
          console.error(err);
        });
      };
    })
    .catch((err) => {
      console.error("Error accessing webcam: ", err);
    });

  startBtn.onclick = () => {
    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  stopBtn.onclick = () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };
</script>
{% endblock %}
