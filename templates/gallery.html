{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/gallery.css" />
{% endblock %}

{% block content %}
	<div class="video-grid" id="videoGrid"></div>
{% endblock %}

{% block scripts %}
<script>
	async function loadVideos() {
		const grid = document.getElementById('videoGrid');
		grid.innerHTML = '<p>Loading videos...</p>';
		try {
			const res = await fetch('/api/videos');
			const videos = await res.json();
			if (!Array.isArray(videos) || videos.length === 0) {
				grid.innerHTML = '<p>No videos found.</p>';
				return;
			}
			grid.innerHTML = '';
			for (const video of videos) {
				// video: [id, path, O_filename, processed]
				const id = video[0];
				let filename = video[2];
				if (filename) {
					filename = filename.replace(/\.[^/.]+$/, "");
				}
				const card = document.createElement('div');
				card.className = 'video-card';
				// Fetch video blob
				const videoRes = await fetch(`/api/videos/${id}`);
				if (!videoRes.ok) {
					card.innerHTML = `<div class="filename">${filename || ''}</div><p>Video not found</p>`;
				} else {
					const blob = await videoRes.blob();
					const url = URL.createObjectURL(blob);
					card.innerHTML = `
						<video src="${url}" controls></video>
						<div class="filename">${filename || ''}</div>
					`;
				}
				grid.appendChild(card);
			}
		} catch (err) {
			grid.innerHTML = '<p>Error loading videos.</p>';
		}
	}
	window.addEventListener('DOMContentLoaded', loadVideos);
</script>
{% endblock %}
